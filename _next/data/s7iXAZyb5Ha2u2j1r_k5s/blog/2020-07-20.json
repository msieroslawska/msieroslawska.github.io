{"pageProps":{"blog":{"date":"2020-07-20","tags":["next.js"],"title":"How on Earth do I deploy next.js to github pages...?","content":"<h2>Jekyll</h2>\n<p>When I initially decided to create a personal page, mostly to document my notes taken during my learning process, first and most popular result in the category of static page generators was Jekyll. I'm used to tinkering and tweaking and breaking the code, and in the end I got it running, but man, adjusting it to my needs was a real chore and the resulting mix of <code>md</code> and <code>html</code> was... an eyesore:</p>\n<pre><code class=\"hljs language-javascript\">---\n---\n\n<span class=\"hljs-comment\">/* eslint object-curly-newline: [\"error\", { \"multiline\": true }] */</span>\n<span class=\"hljs-comment\">/* global document */</span>\n\n<span class=\"hljs-keyword\">let</span> postDay, postMonth, postYear;\n<span class=\"hljs-keyword\">let</span> posts = [];\n\n{% <span class=\"hljs-keyword\">for</span> log <span class=\"hljs-keyword\">in</span> site.posts %}\n  postDay = <span class=\"hljs-string\">\"{{ log.date | date: '%d' }}\"</span>;\n  postMonth = <span class=\"hljs-string\">\"{{log.date | date: '%m'}}\"</span>\n  postYear = <span class=\"hljs-string\">\"{{log.date | date: '%Y'}}\"</span>\n  posts.push(<span class=\"hljs-string\">`<span class=\"hljs-subst\">${postYear}</span>-<span class=\"hljs-subst\">${postMonth}</span>-<span class=\"hljs-subst\">${postDay}</span>`</span>);\n{% endfor %}\n\n<span class=\"hljs-keyword\">const</span> MONTHS = [\n  <span class=\"hljs-string\">'December'</span>, <span class=\"hljs-string\">'November'</span>, <span class=\"hljs-string\">'October'</span>, <span class=\"hljs-string\">'September'</span>, <span class=\"hljs-string\">'August'</span>, <span class=\"hljs-string\">'July'</span>, <span class=\"hljs-string\">'June'</span>, <span class=\"hljs-string\">'May'</span>, <span class=\"hljs-string\">'April'</span>, <span class=\"hljs-string\">'March'</span>, <span class=\"hljs-string\">'February'</span>, <span class=\"hljs-string\">'January'</span>];\n  <span class=\"hljs-comment\">// 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];</span>\n\n<span class=\"hljs-keyword\">const</span> createUrl = <span class=\"hljs-function\">(<span class=\"hljs-params\">{ day, month, year }</span>) =></span> {\n  <span class=\"hljs-keyword\">const</span> url = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'a'</span>);\n  <span class=\"hljs-keyword\">const</span> urlText = <span class=\"hljs-built_in\">document</span>.createTextNode(day);\n  url.appendChild(urlText);\n  url.href = <span class=\"hljs-string\">`{{ site.url }}/blog/codelogs/<span class=\"hljs-subst\">${year}</span>-<span class=\"hljs-subst\">${month}</span>-<span class=\"hljs-subst\">${day}</span>-Codelog.html`</span>;\n  <span class=\"hljs-keyword\">return</span> url;\n};\n\n<span class=\"hljs-keyword\">const</span> createCell = <span class=\"hljs-function\">(<span class=\"hljs-params\">{\n  cellType = <span class=\"hljs-string\">'td'</span>,\n  className = <span class=\"hljs-string\">''</span>,\n  day = <span class=\"hljs-string\">''</span>,\n  isUrl = <span class=\"hljs-literal\">false</span>,\n  month = <span class=\"hljs-string\">''</span>,\n  row,\n  text = <span class=\"hljs-string\">''</span>,\n  year = <span class=\"hljs-string\">''</span>,\n}</span>) =></span> {\n  <span class=\"hljs-keyword\">const</span> cell = <span class=\"hljs-built_in\">document</span>.createElement(cellType);\n\n  <span class=\"hljs-keyword\">if</span> (isUrl) {\n    cell.className = <span class=\"hljs-string\">`<span class=\"hljs-subst\">${className}</span> url`</span>;\n    <span class=\"hljs-keyword\">const</span> url = createUrl({ className, day, month, year });\n    <span class=\"hljs-comment\">// url.className = 'url';</span>\n    cell.appendChild(url);\n  } <span class=\"hljs-keyword\">else</span> {\n    cell.className = className;\n    <span class=\"hljs-keyword\">const</span> cellText = <span class=\"hljs-built_in\">document</span>.createTextNode(text);\n    cell.appendChild(cellText);\n  }\n\n  row.appendChild(cell);\n};\n\n<span class=\"hljs-keyword\">const</span> getNumberOfDays = <span class=\"hljs-function\">(<span class=\"hljs-params\">{\n  month,\n  year = <span class=\"hljs-number\">2019</span>\n}</span>) =></span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Date</span>(<span class=\"hljs-built_in\">Number</span>(year), <span class=\"hljs-built_in\">Number</span>(month) + <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>).getDate();\n\n<span class=\"hljs-keyword\">const</span> createDayCell = <span class=\"hljs-function\">(<span class=\"hljs-params\">{ day, idx, row }</span>) =></span> {\n  <span class=\"hljs-keyword\">const</span> m = idx &#x3C; <span class=\"hljs-number\">9</span> ? <span class=\"hljs-string\">`0<span class=\"hljs-subst\">${idx + <span class=\"hljs-number\">1</span>}</span>`</span> : <span class=\"hljs-string\">`<span class=\"hljs-subst\">${idx + <span class=\"hljs-number\">1</span>}</span>`</span>;\n  <span class=\"hljs-keyword\">const</span> d = day &#x3C; <span class=\"hljs-number\">9</span> ? <span class=\"hljs-string\">`0<span class=\"hljs-subst\">${day + <span class=\"hljs-number\">1</span>}</span>`</span> : <span class=\"hljs-string\">`<span class=\"hljs-subst\">${day + <span class=\"hljs-number\">1</span>}</span>`</span>;\n  <span class=\"hljs-keyword\">const</span> isUrl = <span class=\"hljs-built_in\">Boolean</span>(posts.indexOf(<span class=\"hljs-string\">`2019-<span class=\"hljs-subst\">${m}</span>-<span class=\"hljs-subst\">${d}</span>`</span>) + <span class=\"hljs-number\">1</span>);\n\n  createCell({ <span class=\"hljs-attr\">className</span>: <span class=\"hljs-string\">'cell'</span>, <span class=\"hljs-attr\">day</span>: d, isUrl, <span class=\"hljs-attr\">month</span>: m, row, <span class=\"hljs-attr\">text</span>: d, <span class=\"hljs-attr\">year</span>: <span class=\"hljs-number\">2019</span> });\n};\n\n<span class=\"hljs-keyword\">const</span> generateCalendar = <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-keyword\">const</span> calendar = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'calendar-table'</span>);\n  <span class=\"hljs-keyword\">const</span> currentDate = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Date</span>();\n  <span class=\"hljs-keyword\">let</span> newRow;\n\n  MONTHS.forEach(<span class=\"hljs-function\">(<span class=\"hljs-params\">monthName, i</span>) =></span> {\n    <span class=\"hljs-keyword\">const</span> idx = <span class=\"hljs-number\">11</span> - i;\n    <span class=\"hljs-keyword\">if</span> (currentDate.getMonth() >= <span class=\"hljs-built_in\">Number</span>(idx)) {\n      <span class=\"hljs-keyword\">const</span> monthHeader = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'h3'</span>);\n      monthHeader.className = <span class=\"hljs-string\">'month'</span>;\n      <span class=\"hljs-keyword\">const</span> monthText = <span class=\"hljs-built_in\">document</span>.createTextNode(monthName)\n      monthHeader.appendChild(monthText);\n      calendar.appendChild(monthHeader);\n      <span class=\"hljs-keyword\">const</span> monthTable = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'table'</span>);\n      calendar.appendChild(monthTable);\n\n      <span class=\"hljs-keyword\">let</span> isFirstDay = <span class=\"hljs-literal\">true</span>;\n\n      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'day'</span>, currentDate.getDay())\n\n      <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> day <span class=\"hljs-keyword\">of</span> <span class=\"hljs-built_in\">Array</span>(getNumberOfDays({ <span class=\"hljs-attr\">month</span>: idx })).keys()) {\n        <span class=\"hljs-keyword\">if</span> (isFirstDay || day % <span class=\"hljs-number\">7</span> === <span class=\"hljs-number\">0</span>) {\n          newRow = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'tr'</span>);\n          newRow.className = <span class=\"hljs-string\">'row'</span>;\n\n          <span class=\"hljs-keyword\">if</span> (currentDate.getMonth() === <span class=\"hljs-built_in\">Number</span>(idx)) {\n            <span class=\"hljs-keyword\">if</span> (day &#x3C; currentDate.getDay()) {\n              createDayCell({ day, idx, <span class=\"hljs-attr\">row</span>: newRow });\n\n              monthTable.appendChild(newRow);\n              isFirstDay = <span class=\"hljs-literal\">false</span>;\n            }\n          } <span class=\"hljs-keyword\">else</span> {\n            createDayCell({ day, idx, <span class=\"hljs-attr\">row</span>: newRow });\n\n            monthTable.appendChild(newRow);\n            isFirstDay = <span class=\"hljs-literal\">false</span>;\n          }\n        } <span class=\"hljs-keyword\">else</span> {\n          <span class=\"hljs-keyword\">if</span> (currentDate.getMonth() === <span class=\"hljs-built_in\">Number</span>(idx)) {\n            <span class=\"hljs-keyword\">if</span> (day &#x3C; currentDate.getDay()) {\n              createDayCell({ day, idx, <span class=\"hljs-attr\">row</span>: newRow });\n            }\n          } <span class=\"hljs-keyword\">else</span> {\n            createDayCell({ day, idx, <span class=\"hljs-attr\">row</span>: newRow });\n          }\n        }\n      }\n    }\n  });\n};\n\ngenerateCalendar();</code></pre>\n<p>Yeah... not the prettiest. In case you were wondering, this code was supposed to display a calendar with clickable cells on days when I posted something.</p>\n<h2>Gatsby</h2>\n<p>That's when I decided to move to a shinier engine, with something more modern. Yes! React! GraphQL! Yes! Yes!</p>\n<p>...but wait a moment.</p>\n<p>Yes, that was an overkill. I grew impatient while debugging GraphQL queries and never finished porting the website.</p>\n<h2>Next.js</h2>\n<p>Few months have passed. The idea of my poor, abandoned page covered in dust was like a thorn in my conscience, subtly poking me and reminding me of its existence. During these past months I got a new job, got comfortable with TypeScript working as a full-time dev, why not try again? Perhaps... something simple and yet customizable?</p>\n<p>That's how I ended up with next.js.</p>\n<p>Getting familiar with the build system was a breeze. Integrating markdown files and processing was a bit of a chore, but still manageable. After a weekend, I had a nice, simple page running on my localhost. The time had come to <strong>deploy</strong>!</p>\n<p>Uh oh. How do I deploy?</p>\n<p>Official docs recommend using Vercel. Ummmm, no. I haven't scratched my overcomplicated Gatsby approach only to make it tangled with 3rd party elements again.</p>\n<p>There was plenty of tutorials how to deploy your <strong>project page</strong> under <em>xxxx.github.io/[project-name]</em>. But what about deploying to root directory of the domain, in order to deploy the website?</p>\n<p>I took me another few hours of poking and proding, lots of searching and reading stackoverflow. In the end, the solution which worked for me is the following:</p>\n<ol>\n<li>Two repositories</li>\n</ol>\n<ul>\n<li><em>main github.io repo</em></li>\n<li><em>github.io-source</em></li>\n</ul>\n<ol start=\"2\">\n<li><em>github.io-source</em> hosts the source code of next.js with a nice <em>deploy</em> script in <code>package.json</code>:</li>\n</ol>\n<pre><code class=\"hljs language-javascript\">rm -rf out/ &#x26;&#x26; next build &#x26;&#x26; next <span class=\"hljs-keyword\">export</span> -o out &#x26;&#x26; touch out/.nojekyll &#x26;&#x26; cp -R out/ ../\\[main-repo-folder\\].github.io</code></pre>\n<ol start=\"3\">\n<li><em>main github.io repo</em> has <strong>only</strong> files generated by the deploy script -- <code>_next</code> folder and pure <code>html</code>. The only thing remaining after running deploy from source repo is to commit and push changes in the main repo.</li>\n</ol>\n<p>It's not a perfect solution, yes. Are there better approaches? Perhaps. I was not able to find anything more elegant. Github pages are deploying the <strong>personal page</strong> (root domain) only from your <em>master</em> branch (and root directory), therefore <code>html</code> has to sit directly at root and I didn't want to have my source polluted by it.</p>\n"}},"__N_SSG":true}